<!doctype html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LumenFall - Libro Interactivo</title>

    <!-- Open Graph Meta Tags for Social Sharing -->
    <meta property="og:title" content="LumenFall - Mi Libro Digital Interactivo" />
    <meta property="og:description" content="Te invito a explorar el universo de LumenFall a través de este libro digital. Una nueva aventura te espera." />
    <meta property="og:image" content="https://raw.githubusercontent.com/Yanzsmartwood2025/JUSN38/872aa43a0894e69917f178d71fbc0d7ac1eac8fb/LumenFall-book/assets/imagenes/Portada-libro.jpg" />
    <meta property="og:url" content="#" />
    <meta property="og:type" content="website" />
    
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@400;600;700&family=Merriweather:wght@400;700&family=Lora&display=swap" rel="stylesheet">
    
    <style type="text/css">
        :root {
            --runa-primary: #D47500;
            --slider-track-color: #25D366;
            --header-height: 5rem; /* 80px */
        }
        html { scroll-behavior: smooth; }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            transition: background-color 0.4s ease, color 0.4s ease; 
            margin: 0;
            overflow: hidden;
        }

        #video-background { 
            position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; 
            object-fit: cover; z-index: -2; 
            transition: opacity 0.5s ease-in-out; 
        }
        
        .translucent-panel { 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px); 
        }

        /* --- Theme Styles --- */
        html:not(.dark) body { background-color: #e0e0e0; color: #3a2e2a; }
        html:not(.dark) .translucent-panel { background-color: rgba(255, 255, 255, 0.5); border-color: rgba(0,0,0,0.1); }
        html:not(.dark) .flipbook .page { background-color: #fdfbf7; color: #333; }
        html:not(.dark) .page .content-wrapper h2, html:not(.dark) .page .content-wrapper h3 { color: #1c1c1c; }
        html:not(.dark) .page .content-wrapper p, html:not(.dark) .page .content-wrapper li { color: #4a4a4a; }
        html:not(.dark) .signature { color: #585858; }
        html:not(.dark) .page-number { color: rgba(0, 0, 0, 0.4); }
        html:not(.dark) .mixer-icon-button, html:not(.dark) .view-adjust-button { background-color: #F4F1ED; border-color: #E2E8F0; color: #333; }
        html:not(.dark) .mixer-icon-button.active { border-color: var(--runa-primary); }
        html:not(.dark) input[type="range"] { --track-background: #E2E8F0; }
        html:not(.dark) .video-list-button.active { background-color: rgba(0,0,0,0.1); }
        html:not(.dark) #book-side-title { color: rgba(0,0,0,0.2); }
        html:not(.dark) .copyright-page { color: #888; }


        html.dark body { background-color: #111; color: #E2E8F0; }
        html.dark .translucent-panel { background-color: rgba(0, 0, 0, 0.3); border-color: rgba(255, 255, 255, 0.1); }
        html.dark .flipbook .page { background-color: #2a2a2a; color: #e0e0e0; }
        html.dark .page .content-wrapper h2, html.dark .page .content-wrapper h3 { color: #f0f0f0; }
        html.dark .page .content-wrapper p, html.dark .page .content-wrapper li { color: #cccccc; }
        html.dark .signature { color: #a0a0a0; }
        html.dark .page-number { color: rgba(255, 255, 255, 0.4); }
        html.dark .mixer-icon-button, html.dark .view-adjust-button { background-color: #2D3748; border-color: #4A5568; color: #FFF; }
        html.dark .mixer-icon-button.active { border-color: var(--runa-primary); }
        html.dark input[type="range"] { --track-background: #4A5568; }
        html.dark .video-list-button.active { background-color: rgba(255,255,255,0.15); }
        html.dark #book-side-title { color: rgba(255,255,255,0.2); }
        html.dark .copyright-page { color: #777; }

        .flipbook-viewport { 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; width: 100vw; 
            position: fixed; top: 0; left: 0;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            padding-top: var(--header-height);
            box-sizing: border-box;
            touch-action: pan-y;
        }
        .flipbook-viewport.zoom-enabled {
            touch-action: none;
        }
        .flipbook-viewport.ready {
            visibility: visible;
            opacity: 1;
        }
        .flipbook-container { 
            width: 90vw; 
            height: calc(100vh - var(--header-height) - 1rem);
            max-width: 500px; 
            /* MODIFICACIÓN: Se aumentó la altura máxima en un 15% */
            max-height: 1035px; 
            position: relative; 
            transition: transform 0.2s ease-out;
        }
        @media (min-width: 1024px) {
            .flipbook-container {
                width: 90vw;
                height: calc(100vh - var(--header-height) - 1rem);
                max-width: 1400px; 
                /* MODIFICACIÓN: Se aumentó la altura máxima en un 15% */
                max-height: 1265px; 
            }
        }

        .flipbook { width: 100%; height: 100%; }
        .flipbook .page { box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: background-color 0.3s ease, color 0.3s ease; position: relative; overflow: hidden; }
        .flipbook .hard { background-color: #101010; box-shadow: inset 0 0 5px #000; }
        .cover-page { 
            background-color: #101010 !important;
            background-image: url(https://raw.githubusercontent.com/Yanzsmartwood2025/JUSN38/872aa43a0894e69917f178d71fbc0d7ac1eac8fb/LumenFall-book/assets/imagenes/Portada-libro.jpg);
            background-size: cover !important;
            background-repeat: no-repeat !important;
            background-position: center !important;
        }
        .back-cover-page { 
            background-color: #101010 !important;
            background-image: url(https://raw.githubusercontent.com/Yanzsmartwood2025/JUSN38/32acf737002f499e83f4e3fb63d27b0dd4d44827/LumenFall-book/assets/imagenes/Contraportada-libro.jpg);
            background-size: cover !important;
            background-repeat: no-repeat !important;
            background-position: center !important;
        }

        .page .content-wrapper { padding: 30px; height: 100%; overflow-y: auto; box-sizing: border-box; touch-action: pan-y; }
        .page .content-wrapper h2.handwriting-title { font-family: 'Dancing Script', cursive; font-size: 2.5rem; margin-bottom: 1rem; }
        .page .content-wrapper h3 { font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .page .content-wrapper p, .page .content-wrapper li { font-size: 0.95rem; line-height: 1.6; }
        .page .content-wrapper ul { list-style-type: disc; padding-left: 20px; }
        .page .content-wrapper li { margin-bottom: 1rem; }

        .signature { font-family: 'Dancing Script', cursive; font-size: 1.8rem; text-align: right; margin-top: 2rem; }
        .page-number { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); font-size: 0.9em; }
        
        input[type="range"].styled-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: transparent; border-radius: 5px; outline: none; opacity: 0.8; transition: opacity .2s; }
        input[type="range"].styled-slider:hover { opacity: 1; }
        input[type="range"].styled-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--thumb-color, #fff); cursor: pointer; border-radius: 50%; border: 2px solid; margin-top: -6px; }
        html:not(.dark) input[type="range"].styled-slider::-webkit-slider-thumb { border-color: #FDFBF8; }
        html.dark input[type="range"].styled-slider::-webkit-slider-thumb { border-color: #111; }
        input[type="range"].styled-slider::-moz-range-thumb { width: 20px; height: 20px; background: var(--thumb-color, #fff); cursor: pointer; border-radius: 50%; border: 2px solid; }
        html:not(.dark) input[type="range"].styled-slider::-moz-range-thumb { border-color: #FDFBF8; }
        html.dark input[type="range"].styled-slider::-moz-range-thumb { border-color: #111; }
        input[type="range"].styled-slider::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; border-radius: 5px; background: linear-gradient(to right, var(--track-fill-color, #ccc) var(--value-percent, 0%), var(--track-background) var(--value-percent, 0%)); }
        input[type="range"].styled-slider::-moz-range-track { width: 100%; height: 8px; cursor: pointer; border-radius: 5px; background: linear-gradient(to right, var(--track-fill-color, #ccc) var(--value-percent, 0%), var(--track-background) var(--value-percent, 0%)); }
        
        .mixer-icon-button { border: 2px solid; transition: border-color 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .mixer-icon-button img { width: 100%; height: 100%; object-fit: cover; }
        
        .portal-page .content-wrapper { padding: 0 !important; display: flex; align-items: center; justify-content: center; }
        .portal-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        .portal-overlay { position: relative; z-index: 2; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); }
        .portal-content { text-align: center; padding: 2rem; border-radius: 1rem; color: white; max-width: 90%; }
        .portal-content h2 { font-size: 2rem; font-weight: 700; margin-bottom: 1rem; }
        .portal-content p { font-size: 1rem; margin-bottom: 1.5rem; }
        .portal-button { display: inline-block; padding: 0.75rem 1.5rem; border-radius: 0.5rem; text-decoration: none; font-weight: 600; transition: background-color 0.3s; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); background-color: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); color: white; }
        .portal-button:hover { background-color: rgba(255, 255, 255, 0.25); }

        #page-turn-hint { position: absolute; bottom: 20px; right: 20px; z-index: 100; pointer-events: none; opacity: 0; transition: opacity 0.5s ease-out; }
        #page-turn-hint.visible { opacity: 1; animation: swipe-animation 2.5s ease-in-out infinite; }
        #page-turn-hint i { font-size: 45px; color: rgba(255, 255, 255, 0.7); text-shadow: 0 3px 5px rgba(0,0,0,0.5); }
        @keyframes swipe-animation { 0%, 20% { transform: translate(0, 0); opacity: 0.8; } 60% { transform: translate(-40px, -40px); opacity: 0.8; } 80%, 100% { transform: translate(-40px, -40px); opacity: 0; } }
        
        .video-page { padding: 0 !important; }
        .video-page .page-background-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }

        #book-side-title { position: absolute; left: 2vw; top: 50%; transform: translateY(-50%) rotate(180deg); writing-mode: vertical-rl; font-family: 'Poppins', sans-serif; font-size: 4rem; font-weight: 700; letter-spacing: 0.5rem; opacity: 0.4; display: none; pointer-events: none; }
        @media (min-width: 1024px) { #book-side-title { display: block; } }
        
    </style>
</head>
<body>

<div id="video-background-wrapper">
    <video id="video-background" autoplay loop muted playsinline>
        <source id="video-source" src="https://raw.githubusercontent.com/Yanzsmartwood2025/JUSN38/854320f471ce072f148d973f8955d454d2f7cb64/LumenFall-book/assets/videos/video-1.mp4" type="video/mp4">
    </video>
</div>

<header id="main-header" class="fixed top-0 left-0 right-0 z-40">
    <nav class="container mx-auto px-4 sm:px-6 py-2 flex justify-between items-center h-20">
        <div class="flex-1 flex justify-start items-center space-x-2 sm:space-x-4">
             <button id="theme-toggle" class="p-2 rounded-full text-white" aria-label="Change color theme">
                <svg id="theme-icon-sun" class="h-6 w-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-1.414 8.486l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z"/></svg>
                <svg id="theme-icon-moon" class="h-6 w-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
            </button>
        </div>
        <div class="flex-shrink-0">
             <button id="view-adjust-toggle" class="h-16 w-16 rounded-full overflow-hidden bg-black shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--runa-primary)]">
                <video autoplay loop muted playsinline class="w-full h-full object-cover" style="transform: scale(1.2) translateY(-8%);">
                    <source src="https://raw.githubusercontent.com/Yanzsmartwood2025/JUSN38/bb7aff4aaea46c50153b947702807b29dad413cf/LumenFall-book/assets/videos/Logo-cabezal.mp4" type="video/mp4">
                </video>
            </button>
        </div>
        <div class="flex-1 flex justify-end items-center space-x-2 sm:space-x-4">
            <button id="video-skin-toggle" class="p-2 rounded-full text-white" aria-label="Open video selector">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
            </button>
            <button id="mixer-toggle-button" class="w-9 h-9 rounded-full overflow-hidden focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--runa-primary)]" aria-label="Open ambiance mixer">
                <video autoplay loop muted playsinline class="w-full h-full object-cover">
                    <source src="https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/5ec8a9f9a44f0f1d347867a8b1293a1f8f5dae5e/public/assets/videos/runa-equalizer-video.mp4" type="video/mp4">
                </video>
            </button>
        </div>
    </nav>
    <div id="mixer-panel" class="hidden absolute w-full shadow-lg border-t translucent-panel">
        <div class="container mx-auto px-6 py-4">
            <h3 class="font-semibold text-lg mb-4 text-white">Mezclador de Ambiente</h3>
            <div id="sound-controls" class="space-y-4"></div>
        </div>
    </div>
    <div id="video-skin-panel" class="hidden absolute w-full shadow-lg border-t translucent-panel">
        <div class="container mx-auto px-6 py-4">
            <h3 class="font-semibold text-lg mb-4 text-white">Selector de Video de Fondo</h3>
            <div id="video-list" class="space-y-2"></div>
        </div>
    </div>
     <div id="view-adjust-panel" class="hidden absolute w-full shadow-lg border-t translucent-panel">
        <div class="container mx-auto px-6 py-4 flex flex-col sm:flex-row items-center justify-center gap-4">
            <div class="w-full sm:w-auto flex items-center gap-2">
                 <i class="fas fa-search-minus"></i>
                 <input type="range" id="zoom-slider" min="0.5" max="2" step="0.1" value="1" class="styled-slider w-48">
                 <i class="fas fa-search-plus"></i>
            </div>
            <button id="reset-view-button" class="view-adjust-button w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 rounded-lg border-2 transition-colors">
                <i class="fas fa-undo"></i>
                <span>Restaurar</span>
            </button>
        </div>
    </div>
</header>

<main>
    <div class="flipbook-viewport">
        <h1 id="book-side-title">LUMENFALL</h1>
        <div class="flipbook-container">
            <div class="flipbook">
                <div class="page hard cover-page"></div>
                <div class="page"></div> <!-- Blank flyleaf -->
                <div class="page">
                     <div class="content-wrapper flex flex-col justify-center items-center h-full">
                        <h2 class="text-5xl" style="font-family: 'Merriweather', serif;">LumenFall</h2>
                    </div>
                </div>
                <div class="page">
                    <div class="content-wrapper flex flex-col justify-center items-center h-full text-center">
                        <h1 class="text-6xl font-bold" style="font-family: 'Poppins', sans-serif;">LUMENFALL</h1>
                        <p class="text-2xl mt-4" style="font-family: 'Merriweather', serif;">A LIGHT DIVIDED</p>
                        <p class="mt-24 text-xl">JUSN38 STUDIO</p>
                    </div>
                </div>
                <div class="page">
                     <div class="content-wrapper flex flex-col justify-end items-center h-full pb-10">
                        <div class="text-center text-xs copyright-page">
                            <p>LumenFall © 2025 JUSN38 STUDIO.</p>
                            <p>Todos los derechos reservados.</p>
                            <br>
                            <p>Ninguna parte de esta publicación puede ser reproducida, distribuida o transmitida en cualquier forma o por cualquier medio, sin el permiso previo por escrito del editor.</p>
                            <br>
                            <p class="italic mt-8">Para aquellos que encuentran luz en su propia oscuridad.</p>
                        </div>
                    </div>
                </div>
                <div class="page video-page">
                     <video class="page-background-video" autoplay loop muted playsinline>
                        <source src="https://raw.githubusercontent.com/Yanzsmartwood2025/JUSN38/854320f471ce072f148d973f8955d454d2f7cb64/LumenFall-book/assets/videos/video-1.mp4" type="video/mp4">
                    </video>
                    <div class="page-number">1</div>
                </div>
                <div class="page">
                    <div class="content-wrapper">
                        <h2 class="handwriting-title">Prólogo</h2>
                        <p class="mb-4">Algunos dicen que los demonios no existen, que son solo metáforas que inventamos para nombrar el caos que llevamos dentro. Yo no tengo ese lujo. Para mí, los demonios tienen nombre, rostro y susurran en las esquinas de mi mente, especialmente cuando la noche cae sobre las montañas de Colombia.</p>
                        <p>Mi nombre es Joziel. Y esta no es una historia de heroísmo. Es la crónica de mi caída... y de lo que encontré en la oscuridad.</p>
                    </div>
                    <div class="page-number">2</div>
                </div>
                <div class="page">
                    <div class="content-wrapper">
                        <h2 class="handwriting-title">El Reflejo Roto</h2>
                        <p class="mb-4">Mi primer encuentro fue con un espejo. No uno de vidrio, sino uno formado por un charco de agua de lluvia en una calle de Bogotá. En él no vi mi rostro, sino el de una criatura sonriente con demasiados dientes. Tenía mis ojos, pero ardían con una luz enferma.</p>
                        <p>Los médicos lo llamaron psicosis. Me dieron pastillas para silenciar a los fantasmas y terapia para remendar los traumas que, según ellos, habían abierto las puertas. Pero las puertas, una vez abiertas, rara vez se cierran por completo.</p>
                    </div>
                    <div class="page-number">3</div>
                </div>
                <div class="page">
                    <div class="content-wrapper">
                        <h3>El Pacto Silencioso</h3>
                        <p>Los demonios no siempre gritan. A veces, ofrecen tratos. El mío se llamaba a sí mismo "El Sastre", y prometía coser las heridas de mi alma a cambio de pequeños favores: un susurro aquí, una decisión impulsiva allá. Al principio, parecía un alivio, una forma de controlar el caos. Pero cada puntada que daba en mi espíritu, tiraba de un hilo del mundo real, deshaciendo mi vida lentamente.</p>
                    </div>
                    <div class="page-number">4</div>
                </div>
                <div class="page">
                     <div class="content-wrapper">
                          <h3>La Luz Dividida</h3>
                          <p>Pero hay algo que "El Sastre" no sabía. Dentro de mí, entre los escombros de mi mente, quedaba una chispa. Una luz fragmentada, casi extinta, pero desafiante. No era la luz de un ángel ni la de un héroe. Era algo más antiguo, más terrenal. Era la luz de la voluntad, la terca insistencia de un alma que se niega a ser borrada.</p>
                          <p class="signature mt-4">"Esta es la historia de cómo aprendí a luchar con la oscuridad, usando la mía propia."</p>
                     </div>
                    <div class="page-number">5</div>
                </div>
                <div class="page portal-page">
                    <div class="content-wrapper">
                        <video class="portal-video" autoplay loop muted playsinline src="https://assets.mixkit.co/videos/preview/mixkit-flying-through-a-metaverse-landscape-42846-large.mp4"></video>
                        <div class="portal-overlay translucent-panel">
                            <div class="portal-content">
                                <h2>Comunidad LumenFall</h2>
                                <p>Únete a nuestra comunidad para seguir el desarrollo del juego, compartir tus ideas y conocer a otros guardianes.</p>
                                <a href="#" class="portal-button">Ir a la Comunidad</a>
                            </div>
                        </div>
                    </div>
                    <div class="page-number">6</div>
                </div>
                <div class="page portal-page">
                    <div class="content-wrapper">
                          <video class="portal-video" autoplay loop muted playsinline src="https://assets.mixkit.co/videos/preview/mixkit-a-man-in-a-suit-works-with-a-futuristic-interface-42403-large.mp4"></video>
                          <div class="portal-overlay translucent-panel">
                               <div class="portal-content">
                                   <h2>Conviértete en Tester</h2>
                                   <p>¿Quieres ser de los primeros en explorar Aethel? Inscríbete a nuestra beta cerrada y ayúdanos a forjar el futuro de LumenFall.</p>
                                   <a href="#" class="portal-button">Inscribirse</a>
                               </div>
                          </div>
                    </div>
                    <div class="page-number">7</div>
                </div>
                <div class="page portal-page">
                     <div class="content-wrapper">
                          <video class="portal-video" autoplay loop muted playsinline src="https://assets.mixkit.co/videos/preview/mixkit-futuristic-computer-data-processing-screen-4740-large.mp4"></video>
                          <div class="portal-overlay translucent-panel">
                               <div class="portal-content">
                                   <h2>Jusn38 Tech</h2>
                                   <p>Explora la innovación y el diseño detrás de esta experiencia. Jusn38 Tech, creando el futuro de las interacciones digitales.</p>
                                   <a href="jusn38.html" class="portal-button">Conocer Más</a>
                               </div>
                          </div>
                     </div>
                    <div class="page-number">8</div>
                </div>
                <div class="page hard back-cover-page"></div>
            </div>
            <div id="page-turn-hint">
                <i class="fas fa-hand-pointer"></i>
            </div>
        </div>
    </div>
</main>

<audio id="music-audio" loop><source src="https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/main/public/assets/mp3/runa-main-audio.mp3" type="audio/mpeg"></audio>
<audio id="river-audio" loop><source src="https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/9b1ab5105236fed3644570e1a2ea37f1f1956091/public/assets/mp3/Sonido_de_rio.mp3" type="audio/mpeg"></audio>
<audio id="birds-audio" loop><source src="https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/9b1ab5105236fed3644570e1a2ea37f1f1956091/public/assets/mp3/Sonidos_de_Pajaros.mp3" type="audio/mpeg"></audio>
<audio id="rain-audio" loop><source src="https://raw.githubusercontent.com/pixel-nation/files-for-codepen/master/rain.mp3" type="audio/mpeg"></audio>
<audio id="fire-audio" loop><source src="https://raw.githubusercontent.com/pixel-nation/files-for-codepen/master/fire.mp3" type="audio/mpeg"></audio>
<audio id="wind-audio" loop><source src="https://actions.google.com/sounds/v1/weather/wind_gust.ogg" type="audio/ogg"></audio>
<audio id="storm-audio" loop><source src="https://actions.google.com/sounds/v1/weather/thunder_crack.ogg" type="audio/ogg"></audio>
<audio id="magic-chimes-audio" loop><source src="https://actions.google.com/sounds/v1/magical/magic_chimes.ogg" type="audio/ogg"></audio>
<audio id="cave-ambience-audio" loop><source src="https://actions.google.com/sounds/v1/ambiences/cave_ambience.ogg" type="audio/ogg"></audio>


<script type="module">
    $(document).ready(function () {
        const flipbook = $('.flipbook');
        const flipbookContainer = $('.flipbook-container');
        const viewport = $('.flipbook-viewport');
        const pageFlipSound = new Audio('https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/c2acd6b2dd569ae8ee33f2441eaacb2386e7490d/public/assets/mp3/pasar-hoja-de-libro.mp3');
        
        const videoSkins = [
            { name: "Intro LumenFall", url: "https://raw.githubusercontent.com/Yanzsmartwood2025/JUSN38/854320f471ce072f148d973f8955d454d2f7cb64/LumenFall-book/assets/videos/video-1.mp4" },
            { name: "Bosque Tenebroso", url: "https://assets.mixkit.co/videos/preview/mixkit-gloomy-forest-with-flying-particles-39803-large.mp4" },
            { name: "Naturaleza", url: "https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/abb2e1a716439dd1ba47f48c0bba176ff72e197e/public/assets/videos/runa-fondo-video.mp4" }
        ];
        let currentVideoIndex = 0;

        const ambienceSounds = [
            { id: 'music-audio', name: 'Música', gifSrc: 'https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/741d48f54473497390f1b028f4e2a2b874459088/public/assets/gif/music.gif' },
            { id: 'river-audio', name: 'Río', gifSrc: 'https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/741d48f54473497390f1b028f4e2a2b874459088/public/assets/gif/river.gif' },
            { id: 'birds-audio', name: 'Pájaros', gifSrc: 'https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/741d48f54473497390f1b028f4e2a2b874459088/public/assets/gif/birds.gif' },
            { id: 'rain-audio', name: 'Lluvia', gifSrc: 'https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/1502311c7a2daf5ee882bb36da3e6555680fd5e8/public/assets/gif/rain.gif' },
            { id: 'fire-audio', name: 'Fuego', gifSrc: 'https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/1502311c7a2daf5ee882bb36da3e6555680fd5e8/public/assets/gif/fire.gif' },
            { id: 'wind-audio', name: 'Viento', gifSrc: 'https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/1502311c7a2daf5ee882bb36da3e6555680fd5e8/public/assets/gif/wind.gif' },
            { id: 'storm-audio', name: 'Tormenta', gifSrc: 'https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/1502311c7a2daf5ee882bb36da3e6555680fd5e8/public/assets/gif/storm.gif' },
            { id: 'magic-chimes-audio', name: 'Sonido Mágico', gifSrc: 'https://raw.githubusercontent.com/Yanzsmartwood2025/JUSN38/main/LumenFall-book/assets/gif/Magic.gif' },
            { id: 'cave-ambience-audio', name: 'Cueva', gifSrc: 'https://raw.githubusercontent.com/Yanzsmartwood2025/JUSN38/main/LumenFall-book/assets/gif/Cave.gif' },
        ];
        
        let isZoomEnabled = false;

        function applyTheme(theme) {
            if (theme === 'dark') {
                $('html').removeClass('light').addClass('dark');
            } else {
                $('html').removeClass('dark').addClass('light');
            }
        }

        function closeAllPanels() {
            $('#mixer-panel, #video-skin-panel, #view-adjust-panel').addClass('hidden');
            
            // MODIFICACIÓN: Lógica de zoom y turn.js centralizada aquí
            if (isZoomEnabled) {
                viewport.removeClass('zoom-enabled');
                flipbook.turn('disable', false); // Reactiva el paso de páginas
                isZoomEnabled = false;
            }
        }

        function initializeMixer() {
            const soundControlsContainer = $('#sound-controls');
            soundControlsContainer.html('');
            ambienceSounds.forEach(sound => {
                const audioEl = document.getElementById(sound.id);
                if (!audioEl) return;
                const controlHTML = `<div class="flex items-center gap-4 text-sm text-white"><button id="btn-${sound.id}" class="mixer-icon-button relative w-10 h-10 rounded-full shadow-md flex-shrink-0 overflow-hidden"><img src="${sound.gifSrc}" alt="${sound.name}"></button><span class="font-medium w-20 truncate">${sound.name}</span><input type="range" id="volume-${sound.id}" min="0" max="1" step="0.01" value="0" class="styled-slider" style="--thumb-color: var(--runa-primary); --track-fill-color: var(--slider-track-color);"></div>`;
                soundControlsContainer.append(controlHTML);
                const slider = $(`#volume-${sound.id}`);
                slider.on('input', function() {
                    const newVolume = parseFloat($(this).val());
                    audioEl.volume = newVolume;
                    $(`#btn-${sound.id}`).toggleClass('active', newVolume > 0);
                    updateSliderFill(this);
                    if (newVolume > 0 && audioEl.paused) { audioEl.play().catch(e => console.error(`Error playing ${sound.id}:`, e)); } 
                    else if (newVolume === 0 && !audioEl.paused) { audioEl.pause(); }
                });
                $(`#btn-${sound.id}`).on('click', function() {
                    const currentVolume = parseFloat(slider.val());
                    if (currentVolume > 0) { slider.data('lastValue', currentVolume); slider.val(0); } 
                    else { slider.val(slider.data('lastValue') || 0.5); }
                    slider.trigger('input');
                });
                updateSliderFill(slider[0]);
            });
        }

        function setVideoSkin(index) {
            const video = $('#video-background');
            const source = $('#video-source');
            if (video.length && source.length) {
                video.css('opacity', 0);
                setTimeout(() => {
                    currentVideoIndex = index;
                    source.attr('src', videoSkins[currentVideoIndex].url);
                    const videoElement = video[0];
                    videoElement.load();
                    
                    $(videoElement).off('canplaythrough.autoplay').on('canplaythrough.autoplay', function() {
                        $(this).off('canplaythrough.autoplay'); 
                        const playPromise = videoElement.play();
                        if (playPromise !== undefined) {
                            playPromise.then(_ => {
                                video.css('opacity', 1);
                            }).catch(error => {
                                console.error("Video autoplay was prevented:", error);
                                video.css('opacity', 1);
                            });
                        }
                    });

                    localStorage.setItem('lumenFallVideoSkin', currentVideoIndex);
                    updateVideoListUI();
                }, 500);
            }
        }

        function updateVideoListUI() {
            $('#video-list button').each(function(index) { $(this).toggleClass('active', index === currentVideoIndex); });
        }
        
        function initializeVideoSelector() {
            const videoListContainer = $('#video-list');
            videoListContainer.html('');
            videoSkins.forEach((skin, index) => {
                const button = $(`<button class="video-list-button w-full text-left p-2 rounded-lg transition-colors duration-200 text-white">${skin.name}</button>`);
                button.on('click', () => setVideoSkin(index));
                videoListContainer.append(button);
            });
            updateVideoListUI();
        }

        function updateSliderFill(slider) {
            const min = $(slider).attr('min') || 0, max = $(slider).attr('max') || 100, value = $(slider).val();
            const percent = ((value - min) / (max - min)) * 100;
            $(slider).css('--value-percent', `${percent}%`);
        }

        // --- Responsive Flipbook Logic ---
        function updateFlipbookLayout() {
            const container = $('.flipbook-container');
            const windowWidth = $(window).width();
            const newDisplay = (windowWidth >= 1024) ? 'double' : 'single';

            if (flipbook.turn('display') !== newDisplay) {
                flipbook.turn('display', newDisplay);
            }

            flipbook.turn('size', container.width(), container.height());
        }
        
        // --- Zoom Logic ---
        let currentScale = 1.0;
        const zoomSlider = $('#zoom-slider');

        function applyZoom(scale) {
            currentScale = Math.max(0.5, Math.min(scale, 2));
            flipbookContainer.css('transform', `scale(${currentScale})`);
            zoomSlider.val(currentScale);
            updateSliderFill(zoomSlider[0]);
            localStorage.setItem('lumenFallZoom', currentScale);
        }

        zoomSlider.on('input', function() {
            applyZoom(parseFloat($(this).val()));
        });

        $('#reset-view-button').on('click', () => {
            applyZoom(1.0);
        });

        const viewportElement = viewport[0];
        let initialPinchDistance = null;
        let lastScale = 1;

        viewportElement.addEventListener('touchstart', (e) => {
            if (!isZoomEnabled || e.touches.length !== 2) return;
            e.preventDefault();
            initialPinchDistance = Math.hypot(
                e.touches[0].pageX - e.touches[1].pageX,
                e.touches[0].pageY - e.touches[1].pageY
            );
            lastScale = currentScale;
        }, { passive: false });

        viewportElement.addEventListener('touchmove', (e) => {
            if (!isZoomEnabled || e.touches.length !== 2) return;
            e.preventDefault();
            const newPinchDistance = Math.hypot(
                e.touches[0].pageX - e.touches[1].pageX,
                e.touches[0].pageY - e.touches[1].pageY
            );
            if (initialPinchDistance) {
                const scaleRatio = newPinchDistance / initialPinchDistance;
                applyZoom(lastScale * scaleRatio);
            }
        }, { passive: false });

        viewportElement.addEventListener('touchend', () => {
            initialPinchDistance = null;
        });

        viewportElement.addEventListener('wheel', (e) => {
            if (!isZoomEnabled) return;
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            applyZoom(currentScale + delta);
        }, { passive: false });


        // --- Initial Setup and Event Handlers ---
        flipbook.turn({
            display: 'single', elevation: 50, gradients: true, autoCenter: true,
            when: {
                turned: (event, page, view) => {
                    if (page > 1) {
                        pageFlipSound.currentTime = 2.2;
                        pageFlipSound.play().catch(console.error);
                        setTimeout(() => pageFlipSound.pause(), 1000);
                    }
                }
            }
        });
        
        $(window).on('resize', updateFlipbookLayout);
        updateFlipbookLayout();
        viewport.addClass('ready');
        
        $('#theme-toggle').on('click', () => { const newTheme = $('html').hasClass('dark') ? 'light' : 'dark'; localStorage.setItem('lumenFallTheme', newTheme); applyTheme(newTheme); });
        $('#mixer-toggle-button').on('click', (e) => { e.stopPropagation(); const wasOpen = !$('#mixer-panel').hasClass('hidden'); closeAllPanels(); if (!wasOpen) $('#mixer-panel').removeClass('hidden'); });
        $('#video-skin-toggle').on('click', (e) => { e.stopPropagation(); const wasOpen = !$('#video-skin-panel').hasClass('hidden'); closeAllPanels(); if (!wasOpen) $('#video-skin-panel').removeClass('hidden'); });
        
        $('#view-adjust-toggle').on('click', (e) => { 
            e.stopPropagation(); 
            const wasOpen = !$('#view-adjust-panel').hasClass('hidden'); 
            closeAllPanels(); 
            if (!wasOpen) {
                $('#view-adjust-panel').removeClass('hidden');
                // MODIFICACIÓN: Habilita el modo zoom y deshabilita turn.js
                viewport.addClass('zoom-enabled');
                flipbook.turn('disable', true);
                isZoomEnabled = true;
            }
        });
        
        $(window).on('click', (e) => { if (!$(e.target).closest('#main-header').length) closeAllPanels(); });

        const pageTurnHint = $('#page-turn-hint');
        if (localStorage.getItem('lumenFallHintSeen') !== 'true') {
            setTimeout(() => pageTurnHint.addClass('visible'), 1500);
            flipbook.one('turned', () => { pageTurnHint.removeClass('visible'); localStorage.setItem('lumenFallHintSeen', 'true'); });
        }

        // --- Final Initializations ---
        const savedZoom = parseFloat(localStorage.getItem('lumenFallZoom')) || 1.0;
        applyZoom(savedZoom);
        
        applyTheme(localStorage.getItem('lumenFallTheme') || 'dark');
        initializeMixer();
        initializeVideoSelector();
        setVideoSkin(parseInt(localStorage.getItem('lumenFallVideoSkin')) || 0);
    });
</script>

</body>
</html>
