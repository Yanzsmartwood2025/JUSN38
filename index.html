<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Jusn38 - Centro de Creación Digital</title>
    
    <!-- Metatags y Estilos -->
    <meta name="theme-color" content="#0c0a18">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/main/public/assets/imagenes/logo_jusn38.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        @keyframes fill-bar {
            from { width: 0%; }
            to { width: 100%; }
        }

        @keyframes screen-shake {
            0% { transform: translate(3px, 3px) rotate(0deg); }
            10% { transform: translate(-3px, -6px) rotate(-3deg); }
            20% { transform: translate(-9px, 0px) rotate(3deg); }
            30% { transform: translate(9px, 6px) rotate(0deg); }
            40% { transform: translate(3px, -3px) rotate(3deg); }
            50% { transform: translate(-3px, 6px) rotate(-3deg); }
            60% { transform: translate(-9px, 3px) rotate(0deg); }
            70% { transform: translate(9px, 3px) rotate(-3deg); }
            80% { transform: translate(-3px, -3px) rotate(3deg); }
            90% { transform: translate(3px, 6px) rotate(0deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        .shaking {
            animation: screen-shake 0.5s;
        }

        body { 
            font-family: 'Rajdhani', sans-serif; 
            background-color: #0c0a18; 
            background-image: radial-gradient(circle at top right, rgba(255, 255, 255, 0.05), transparent 40%), radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.1), transparent 40%); 
            color: #cbd5e0;
            margin: 0;
            overflow: hidden;
            -webkit-user-select: none; user-select: none;
        }
        
        #scene-container {
            position: absolute; top: 0; left: 0;
            width: 100vw; height: 100vh;
            cursor: grab;
            touch-action: none;
        }
        #scene-container:active { cursor: grabbing; }

        .project-card-3d {
            width: 320px;
            height: 240px;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
            -webkit-touch-callout: none;
        }
        .project-card-3d.focused {
            box-shadow: 0 0 30px rgba(173, 216, 230, 0.4), 0 0 15px rgba(255, 255, 255, 0.3);
            border-color: rgba(173, 216, 230, 0.5);
        }
        .project-card-3d.card-active {
            box-shadow: 0 0 100px rgba(255, 255, 255, 1), 0 0 60px rgba(173, 216, 230, 1);
            border-color: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }

        .glass-card { 
            background: rgba(12, 10, 24, 0.5);
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            position: relative;
        }
        
        .card-video-bg {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; object-fit: cover;
            z-index: 1; opacity: 0.5; transition: opacity 0.3s ease;
        }
        .project-card-3d:hover .card-video-bg { opacity: 0.8; }

        .card-content {
            position: relative; z-index: 2; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.7);
        }

        /* --- ESTILOS PARA EL MARCO Y LA BARRA DE CARGA (MODIFICADO) --- */
        .monitor-bezel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(to top, #18181f, #2a2a33);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0 0 8px 8px;
            z-index: 3;
            box-shadow: 0px 8px 25px -5px rgba(255, 255, 255, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
        }
        .loading-bar-container {
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            display: none;
        }
        .loading-bar-fill {
            width: 0%;
            height: 100%;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 0 8px white;
        }
        .project-card-3d.is-charging .loading-bar-container {
            display: block;
        }
        .project-card-3d.is-charging .loading-bar-fill {
            animation: fill-bar 4s linear forwards;
        }
    </style>
</head>
<body>
    <div id="scene-container"></div>

    <div id="html-elements" style="display: none;">
        <!-- HTML MODIFICADO: Barra de carga dentro del marco -->
        <a href="caja_de_herramientas.html" class="project-card-3d">
            <div class="glass-card rounded-lg w-full h-full">
                <video class="card-video-bg" autoplay loop muted playsinline><source src="https://videos.pexels.com/video-files/853875/853875-hd_1280_720_25fps.mp4" type="video/mp4"></video>
                <div class="card-content p-6 text-center">
                    <div class="flex justify-center mb-4"><svg class="w-12 h-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.472-2.472a3.375 3.375 0 000-4.773L11.42 5.42a3.375 3.375 0 00-4.773 0L2.25 9.828a3.375 3.375 0 000 4.773l2.472 2.472M11.42 15.17L5.877 21" /></svg></div>
                    <h2 class="text-xl font-bold text-white">Caja de Herramientas</h2>
                    <p class="text-slate-300 mt-1 text-sm">Generadores y utilidades.</p>
                </div>
                <div class="monitor-bezel">
                    <div class="loading-bar-container"><div class="loading-bar-fill"></div></div>
                </div>
            </div>
        </a>
        <!-- Repetir la misma estructura para las demás tarjetas -->
        <a href="lumenfall.html" class="project-card-3d">
            <div class="glass-card rounded-lg w-full h-full">
                <video class="card-video-bg" autoplay loop muted playsinline><source src="https://videos.pexels.com/video-files/4784400/4784400-hd_1280_720_30fps.mp4" type="video/mp4"></video>
                <div class="card-content p-6 text-center">
                    <div class="flex justify-center mb-4"><svg class="w-12 h-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" /></svg></div>
                    <h2 class="text-xl font-bold text-white">Lumenfall</h2>
                    <p class="text-slate-300 mt-1 text-sm">Prototipo de juego de defensa.</p>
                </div>
                <div class="monitor-bezel">
                    <div class="loading-bar-container"><div class="loading-bar-fill"></div></div>
                </div>
            </div>
        </a>
        <a href="formula-1.html" class="project-card-3d">
            <div class="glass-card rounded-lg w-full h-full">
                <video class="card-video-bg" autoplay loop muted playsinline><source src="https://videos.pexels.com/video-files/2103949/2103949-hd_1280_720_24fps.mp4" type="video/mp4"></video>
                <div class="card-content p-6 text-center">
                     <div class="flex justify-center mb-4"><svg class="w-12 h-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0l2.77-.693a9 9 0 016.208.682l.108.054a9 9 0 006.086.71l3.114-.732a48.524 48.524 0 01-.005-10.499l-3.11.732a9 9 0 01-6.085-.711l-.108-.054a9 9 0 00-6.208-.682L3 4.5M3 15V4.5" /></svg></div>
                    <h2 class="text-xl font-bold text-white">Fórmula 1</h2>
                    <p class="text-slate-300 mt-1 text-sm">Simulador de carreras 3D.</p>
                </div>
                <div class="monitor-bezel">
                    <div class="loading-bar-container"><div class="loading-bar-fill"></div></div>
                </div>
            </div>
        </a>
        <a href="https://runacoffee.vercel.app" target="_blank" class="project-card-3d">
            <div class="glass-card rounded-lg w-full h-full">
                <video class="card-video-bg" autoplay loop muted playsinline><source src="https://videos.pexels.com/video-files/3254013/3254013-hd_1280_720_30fps.mp4" type="video/mp4"></video>
                <div class="card-content p-6 text-center">
                     <div class="flex justify-center mb-4"><svg class="w-12 h-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 21v-7.5A.75.75 0 0114.25 12h.01a.75.75 0 01.75.75v7.5m-4.5 0v-7.5A.75.75 0 009.75 12h.01a.75.75 0 00-.75.75v7.5m-4.5 0v-7.5A.75.75 0 015.25 12h.01a.75.75 0 01.75.75v7.5m-4.5 0V9A.75.75 0 012.25 8.25h19.5A.75.75 0 0122.5 9v12m-18 0a.75.75 0 00.75.75h16.5a.75.75 0 00.75-.75m-18 0v-7.5A.75.75 0 015.25 12h13.5a.75.75 0 01.75.75v7.5" /></svg></div>
                    <h2 class="text-xl font-bold text-white">Runa Coffee</h2>
                    <p class="text-slate-300 mt-1 text-sm">Alianza estratégica.</p>
                </div>
                <div class="monitor-bezel">
                    <div class="loading-bar-container"><div class="loading-bar-fill"></div></div>
                </div>
            </div>
        </a>
        <a href="https://yanz-smart-wood.vercel.app" target="_blank" class="project-card-3d">
            <div class="glass-card rounded-lg w-full h-full">
                <video class="card-video-bg" autoplay loop muted playsinline><source src="https://videos.pexels.com/video-files/4491882/4491882-hd_1280_720_25fps.mp4" type="video/mp4"></video>
                <div class="card-content p-6 text-center">
                    <div class="flex justify-center mb-4"><svg class="w-12 h-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 00-2.433 2.471z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3.75 3.75 0 00.495-7.467 5.99 5.99 0 00-1.925 3.546 5.974 5.974 0 01-2.133-1.001A3.75 3.75 0 0012 18z" /></svg></div>
                    <h2 class="text-xl font-bold text-white">Yan'z Smart Wood</h2>
                    <p class="text-slate-300 mt-1 text-sm">Diseño y tecnología.</p>
                </div>
                <div class="monitor-bezel">
                    <div class="loading-bar-container"><div class="loading-bar-fill"></div></div>
                </div>
            </div>
        </a>
        <a href="#" class="project-card-3d">
            <div class="glass-card rounded-lg w-full h-full">
                <video class="card-video-bg" autoplay loop muted playsinline><source src="https://videos.pexels.com/video-files/3994383/3994383-hd_1280_720_25fps.mp4" type="video/mp4"></video>
                <div class="card-content p-6 text-center">
                     <div class="flex justify-center mb-4"><svg class="w-12 h-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.624l-.219.219a1.5 1.5 0 01-2.121 0l-.219-.219a1.5 1.5 0 010-2.121l.219-.219a1.5 1.5 0 012.121 0l.219.219a1.5 1.5 0 010 2.121z" /></svg></div>
                    <h2 class="text-xl font-bold text-white">IA "Aria"</h2>
                    <p class="text-slate-300 mt-1 text-sm">Experimentos con IA.</p>
                </div>
                <div class="monitor-bezel">
                    <div class="loading-bar-container"><div class="loading-bar-fill"></div></div>
                </div>
            </div>
        </a>
        <a href="#" class="project-card-3d">
            <div class="glass-card rounded-lg w-full h-full">
                <video class="card-video-bg" autoplay loop muted playsinline><source src="https://videos.pexels.com/video-files/3194234/3194234-hd_1280_720_25fps.mp4" type="video/mp4"></video>
                <div class="card-content p-6 text-center">
                     <div class="flex justify-center mb-4"><svg class="w-12 h-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <h2 class="text-xl font-bold text-white">Publicidad</h2>
                    <p class="text-slate-300 mt-1 text-sm">Nuestros patrocinadores.</p>
                </div>
                <div class="monitor-bezel">
                    <div class="loading-bar-container"><div class="loading-bar-fill"></div></div>
                </div>
            </div>
        </a>
    </div>

    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    { "imports": { 
        "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js", 
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/" 
    } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

        // --- Declaración de variables globales ---
        let camera, scene, renderer, cssScene, cssRenderer, coreObject, sceneContainer;
        const carouselGroup = new THREE.Group();
        const tentaclesGroup = new THREE.Group();
        const clock = new THREE.Clock();
        const textureLoader = new THREE.TextureLoader();
        
        let focusedObject = null;
        let isPointerDown = false, isDragging = false;
        let startPointerX = 0, startRotationY = 0, velocityY = 0;
        const deceleration = 0.95;
        let longPressTimeout = null;
        let isHolding = false;
        let heldObject = null;
        let pressStartTime = 0;
        let shakeInterval = null;

        // --- Variables del sistema de partículas para chispas ---
        let sparkParticles, sparkGeometry, sparkMaterial;
        const particleCount = 4000; // Más partículas para un efecto denso
        const particlesData = [];
        const gravity = new THREE.Vector3(0, -200, 0);

        const lightningTexture = textureLoader.load('https://i.imgur.com/Y4uK349.png');
        lightningTexture.wrapS = THREE.RepeatWrapping;
        lightningTexture.wrapT = THREE.RepeatWrapping;

        const shellNormalMap = textureLoader.load('https://i.imgur.com/bKPSm9G.png');
        shellNormalMap.wrapS = THREE.RepeatWrapping;
        shellNormalMap.wrapT = THREE.RepeatWrapping;

        const sparkTexture = textureLoader.load('https://i.imgur.com/e40Lcf5.png');

        function main() {
            init();
            animate();
        }

        function init() {
            sceneContainer = document.getElementById('scene-container');
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 5000);
            
            scene = new THREE.Scene();
            cssScene = new THREE.Scene();
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0x88aaff, 2, 2000);
            scene.add(pointLight);

            const coreGeometry = new THREE.IcosahedronGeometry(150, 3);
            const coreTexture = textureLoader.load('https://i.imgur.com/uN2cNW6.jpeg');
            coreTexture.wrapS = THREE.RepeatWrapping;
            coreTexture.wrapT = THREE.RepeatWrapping;
            const coreMaterial = new THREE.MeshBasicMaterial({ 
                map: coreTexture, blending: THREE.AdditiveBlending,
                transparent: true, opacity: 0.9, side: THREE.BackSide
            });
            coreObject = new THREE.Mesh(coreGeometry, coreMaterial);
            scene.add(coreObject);

            initSparks();

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            sceneContainer.appendChild(renderer.domElement);

            cssRenderer = new CSS3DRenderer();
            cssRenderer.setSize(window.innerWidth, window.innerHeight);
            cssRenderer.domElement.style.position = 'absolute';
            cssRenderer.domElement.style.top = 0;
            sceneContainer.appendChild(cssRenderer.domElement);

            const elements = document.querySelectorAll('#html-elements .project-card-3d');
            elements.forEach((element, i) => {
                const cssObject = new CSS3DObject(element);
                cssObject.userData.id = i;
                carouselGroup.add(cssObject);
            });
            cssScene.add(carouselGroup);
            
            scene.add(tentaclesGroup);

            updateLayout();
            createTentacles();

            sceneContainer.addEventListener('pointerdown', onPointerDown);
            sceneContainer.addEventListener('pointermove', onPointerMove);
            sceneContainer.addEventListener('pointerup', onPointerUp);
            sceneContainer.addEventListener('pointerleave', onPointerUp);
            sceneContainer.addEventListener('contextmenu', (event) => event.preventDefault());
            window.addEventListener('resize', onWindowResize);
        }

        function initSparks() {
            sparkGeometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);

            for (let i = 0; i < particleCount; i++) {
                positions[i * 3] = 0;
                positions[i * 3 + 1] = 0;
                positions[i * 3 + 2] = 0;
                particlesData.push({
                    velocity: new THREE.Vector3(),
                    lifetime: 0,
                    isActive: false
                });
            }

            sparkGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            sparkMaterial = new THREE.PointsMaterial({
                map: sparkTexture,
                size: 12,
                blending: THREE.AdditiveBlending,
                transparent: true,
                depthWrite: false,
            });
            sparkParticles = new THREE.Points(sparkGeometry, sparkMaterial);
            sparkParticles.visible = false;
            scene.add(sparkParticles);
        }

        function triggerSparks(position) {
            sparkParticles.position.copy(position);
            sparkParticles.visible = true;
            let particlesToEmit = 10; // Chorro de chispas

            for (let i = 0; i < particleCount && particlesToEmit > 0; i++) {
                const particle = particlesData[i];
                if (!particle.isActive) {
                    particle.isActive = true;
                    particle.lifetime = Math.random() * 0.8 + 0.2;
                    const positions = sparkGeometry.attributes.position.array;
                    positions[i * 3] = 0;
                    positions[i * 3 + 1] = 0;
                    positions[i * 3 + 2] = 0;

                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 300 + 200;
                    particle.velocity.set(
                        Math.cos(angle) * speed,
                        Math.random() * 200 + 50,
                        Math.sin(angle) * speed
                    );
                    particlesToEmit--;
                }
            }
        }

        function updateSparks(delta) {
            if (!sparkParticles.visible) return;
            const positions = sparkGeometry.attributes.position.array;
            let activeParticles = 0;

            for (let i = 0; i < particleCount; i++) {
                const particle = particlesData[i];
                if (particle.isActive) {
                    particle.lifetime -= delta;
                    if (particle.lifetime <= 0) {
                        particle.isActive = false;
                        positions[i * 3] = 0;
                        positions[i * 3 + 1] = 0;
                        positions[i * 3 + 2] = 0;
                        continue;
                    }
                    particle.velocity.add(gravity.clone().multiplyScalar(delta));
                    positions[i * 3] += particle.velocity.x * delta;
                    positions[i * 3 + 1] += particle.velocity.y * delta;
                    positions[i * 3 + 2] += particle.velocity.z * delta;
                    activeParticles++;
                }
            }
            if (activeParticles === 0 && !isHolding) {
                sparkParticles.visible = false;
            }
            sparkGeometry.attributes.position.needsUpdate = true;
        }

        function updateLayout() {
            const isMobile = window.innerWidth < 768;
            const radius = isMobile ? 700 : 850;
            const cardScale = isMobile ? 0.8 : 1.0;
            camera.position.z = isMobile ? 1200 : 1000;

            carouselGroup.children.forEach((object, i) => {
                const numElements = carouselGroup.children.length;
                const angle = (i / numElements) * Math.PI * 2;
                object.position.x = Math.sin(angle) * radius;
                object.position.z = Math.cos(angle) * radius;
                object.scale.set(cardScale, cardScale, cardScale);
            });
        }

        function createTentacles() {
            while(tentaclesGroup.children.length > 0){
                const tentacleGroup = tentaclesGroup.children[0];
                tentaclesGroup.remove(tentacleGroup);
                tentacleGroup.traverse(child => {
                    if (child.isMesh) {
                        child.geometry.dispose();
                        if(child.material.map) child.material.map.dispose();
                        child.material.dispose();
                    }
                });
            }

            const shellMaterial = new THREE.MeshStandardMaterial({
                color: 0x9a9aaf,
                metalness: 0.9,
                roughness: 0.3,
                normalMap: shellNormalMap,
                normalScale: new THREE.Vector2(2, 2)
            });
            const segmentGeometry = new THREE.TorusGeometry(10.5, 3.6, 8, 16);

            carouselGroup.children.forEach((targetObject, i) => {
                const tentacleGroup = new THREE.Group();
                const restingRadius = 250;
                const angle = (Math.random() - 0.5) * Math.PI;
                const restingPoint = new THREE.Vector3(
                    Math.cos(angle) * restingRadius,
                    (Math.random() - 0.5) * 200,
                    Math.sin(angle) * restingRadius
                );

                const curve = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(0,0,0), 
                    restingPoint.clone().multiplyScalar(0.5),
                    restingPoint
                ]);

                const coreGeometry = new THREE.TubeGeometry(curve, 32, 6, 8, false);
                const coreMaterial = new THREE.MeshBasicMaterial({
                    color: 0x00aaff,
                    blending: THREE.AdditiveBlending,
                    transparent: true,
                    opacity: 0.6
                });
                const innerCore = new THREE.Mesh(coreGeometry, coreMaterial);
                tentacleGroup.add(innerCore);

                const electricityGeometry = new THREE.TubeGeometry(curve, 32, 6.2, 8, false);
                const electricityMaterial = new THREE.MeshBasicMaterial({
                    map: lightningTexture,
                    blending: THREE.AdditiveBlending,
                    transparent: true,
                    depthWrite: false,
                    opacity: 0.8
                });
                const electricityEffect = new THREE.Mesh(electricityGeometry, electricityMaterial);
                tentacleGroup.add(electricityEffect);

                const segments = [];
                const numSegments = 40;
                for (let j = 0; j < numSegments; j++) {
                    const segment = new THREE.Mesh(segmentGeometry, shellMaterial);
                    segments.push(segment);
                    tentacleGroup.add(segment);
                }
                
                tentacleGroup.userData = {
                    targetId: i,
                    restingPoint: restingPoint,
                    midPointBase: curve.points[1].clone(),
                    animationOffset: Math.random() * Math.PI * 2,
                    pulseAnimation: null,
                    innerCore: innerCore,
                    electricityEffect: electricityEffect,
                    segments: segments,
                    connectionPoint: new THREE.Vector3()
                };
                tentaclesGroup.add(tentacleGroup);
            });
        }
        
        function updateTentacleGeometry(tentacleGroup, time) {
            const { innerCore, electricityEffect, segments, midPointBase, animationOffset, connectionPoint } = tentacleGroup.userData;
            const curve = innerCore.geometry.parameters.path;

            electricityEffect.material.map.offset.x = time * -0.6;

            curve.points[1].x = midPointBase.x + Math.sin(time * 0.7 + animationOffset) * 30;
            curve.points[1].y = midPointBase.y + Math.cos(time * 0.5 + animationOffset) * 40;
            curve.points[1].z = midPointBase.z + Math.sin(time * 0.6 + animationOffset) * 30;

            connectionPoint.copy(curve.points[2]);
            tentacleGroup.localToWorld(connectionPoint);

            const newCoreGeom = new THREE.TubeGeometry(curve, 32, 6, 8, false);
            const newElectricityGeom = new THREE.TubeGeometry(curve, 32, 6.2, 8, false);
            
            innerCore.geometry.dispose();
            electricityEffect.geometry.dispose();

            innerCore.geometry = newCoreGeom;
            electricityEffect.geometry = newElectricityGeom;

            const newPoints = curve.getPoints(segments.length - 1);
            for (let i = 0; i < segments.length; i++) {
                const segment = segments[i];
                if (newPoints[i]) {
                    segment.position.copy(newPoints[i]);
                    if (i < newPoints.length - 1) {
                        segment.lookAt(newPoints[i + 1]);
                    } else if (newPoints[i-1]) {
                        const direction = newPoints[i].clone().sub(newPoints[i-1]);
                        segment.lookAt(newPoints[i].clone().add(direction));
                    }
                }
            }
        }

        function engageTentacle(tentacle, targetObject) {
            if (!tentacle) return;
            const targetPosition = targetObject.position.clone();
            targetPosition.y -= 110; 
            const curve = tentacle.userData.innerCore.geometry.parameters.path;
            gsap.to(curve.points[2], {
                x: targetPosition.x, y: targetPosition.y, z: targetPosition.z,
                duration: 0.5, ease: "power3.out",
            });
        }

        function disengageTentacle(tentacle) {
            if (!tentacle) return;
            const restingPoint = tentacle.userData.restingPoint;
            const curve = tentacle.userData.innerCore.geometry.parameters.path;
            gsap.to(curve.points[2], {
                x: restingPoint.x, y: restingPoint.y, z: restingPoint.z,
                duration: 0.8, ease: "elastic.out(1, 0.5)",
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            const time = clock.getElapsedTime();
            
            if (coreObject) {
                coreObject.rotation.y += delta * 0.2;
                coreObject.material.map.offset.y = time * 0.05;
            }

            if (!isPointerDown) {
                 if (Math.abs(velocityY) > 0.0001) {
                    carouselGroup.rotation.y += velocityY;
                    tentaclesGroup.rotation.y += velocityY;
                    velocityY *= deceleration;
                } else {
                    velocityY = 0;
                }
            }
            
            let maxDot = -2;
            let newlyFocusedObject = null;
            carouselGroup.children.forEach(object => {
                object.lookAt(camera.position);
                const worldPosition = new THREE.Vector3();
                object.getWorldPosition(worldPosition);
                const cameraDirection = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
                const objectDirection = worldPosition.sub(camera.position).normalize();
                const dot = cameraDirection.dot(objectDirection);

                if (dot > maxDot) {
                    maxDot = dot;
                    newlyFocusedObject = object;
                }
                if (object !== heldObject) {
                    object.element.classList.remove('focused');
                }
            });

            if (newlyFocusedObject && newlyFocusedObject !== focusedObject) {
                focusedObject = newlyFocusedObject;
            }
            if(focusedObject && !isHolding) focusedObject.element.classList.add('focused');

            tentaclesGroup.children.forEach(tentacle => {
                updateTentacleGeometry(tentacle, time);
            });

            if (isHolding && heldObject) {
                 const tentacle = tentaclesGroup.children.find(t => t.userData.targetId === heldObject.userData.id);
                 if (tentacle) {
                     triggerSparks(tentacle.userData.connectionPoint);
                 }
            }
            updateSparks(delta);

            renderer.render(scene, camera);
            cssRenderer.render(cssScene, camera);
        }
        
        const gsapScript = document.createElement('script');
        gsapScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js';
        document.body.appendChild(gsapScript);

        function navigateTo(element) {
            if (element.target === '_blank') {
                window.open(element.href, '_blank');
            } else {
                window.location.href = element.href;
            }
        }

        function startCharging(element) {
            isHolding = true;
            heldObject = carouselGroup.children.find(o => o.element === element);
            
            if (heldObject) {
                element.classList.add('is-charging');
                const tentacle = tentaclesGroup.children.find(t => t.userData.targetId === heldObject.userData.id);
                engageTentacle(tentacle, heldObject);

                if(shakeInterval) clearInterval(shakeInterval);
                shakeInterval = setInterval(() => {
                    sceneContainer.classList.remove('shaking');
                    void sceneContainer.offsetWidth;
                    sceneContainer.classList.add('shaking');
                }, 500);

                longPressTimeout = setTimeout(() => {
                    if (isHolding && heldObject) {
                        element.classList.add('card-active');
                        navigateTo(element);
                    }
                }, 4000);
            }
        }

        function stopCharging() {
            if (isHolding && heldObject) {
                heldObject.element.classList.remove('is-charging');
                const tentacle = tentaclesGroup.children.find(t => t.userData.targetId === heldObject.userData.id);
                disengageTentacle(tentacle);
            }
            
            clearTimeout(longPressTimeout);
            clearInterval(shakeInterval);
            shakeInterval = null;
            isHolding = false;
            heldObject = null;
            sparkParticles.visible = false;
        }

        function onPointerDown(event) {
            isPointerDown = true;
            isDragging = false;
            startPointerX = event.clientX;
            startRotationY = carouselGroup.rotation.y;
            velocityY = 0;
            pressStartTime = Date.now();

            const element = event.target.closest('.project-card-3d');
            if (element) {
                startCharging(element);
            }
        }

        function onPointerMove(event) {
            if (!isPointerDown) return;
            const deltaX = event.clientX - startPointerX;

            const rotationFactor = 0.005; 
            const newRotation = startRotationY + (deltaX * rotationFactor);
            velocityY = newRotation - carouselGroup.rotation.y;
            carouselGroup.rotation.y = newRotation;
            tentaclesGroup.rotation.y = newRotation;
            
            if (Math.abs(deltaX) > 15) {
                isDragging = true;
                stopCharging();
            }
        }

        function onPointerUp(event) {
            if (!isDragging && isHolding) {
                const pressDuration = Date.now() - pressStartTime;
                if (pressDuration < 250) {
                    navigateTo(heldObject.element);
                }
            }
            
            stopCharging();
            isPointerDown = false;
            isDragging = false; 
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            cssRenderer.setSize(window.innerWidth, window.innerHeight);
            updateLayout();
            createTentacles();
        }

        window.addEventListener('load', main);
    </script>
</body>
</html>
