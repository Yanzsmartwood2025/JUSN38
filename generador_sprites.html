<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SpriteSheet Studio v15 (Direct Access)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6; --secondary: #1f2937; --background: #111827;
            --text-light: #f3f4f6; --text-dark: #9ca3af; --border-color: #374151;
            --danger: #ef4444;
        }
        html, body { 
            background-color: var(--background); 
            color: var(--text-light); 
            font-family: 'Inter', sans-serif; 
        }
        .editor-container { 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
            max-width: 900px; 
            margin: auto; 
        }
        #video-container { 
            position: relative; 
            background-color: #000; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: default; 
            min-height: 300px;
        }
        #video-container.eyedropper-active { cursor: crosshair; }
        #video-player { max-width: 100%; max-height: 100%; display: block; }
        
        #video-crop-box { position: absolute; border: 2px dashed var(--primary); box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); cursor: move; display: none; }
        .video-crop-handle { position: absolute; width: 12px; height: 12px; background-color: var(--primary); border: 2px solid white; border-radius: 50%; }
        .video-crop-handle.nw { top: -6px; left: -6px; cursor: nwse-resize; }
        .video-crop-handle.ne { top: -6px; right: -6px; cursor: nesw-resize; }
        .video-crop-handle.sw { bottom: -6px; left: -6px; cursor: nesw-resize; }
        .video-crop-handle.se { bottom: -6px; right: -6px; cursor: nwse-resize; }

        .timeline-controls { padding: 0.5rem 1rem; background-color: var(--secondary); flex-shrink: 0; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: #4b5563; border-radius: 3px; outline: none; transition: opacity 0.2s; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--primary); border-radius: 50%; cursor: pointer; }
        input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; background: var(--primary); border-radius: 50%; cursor: pointer; }

        .toolbar { padding: 1rem; background-color: var(--secondary); border-top: 1px solid var(--border-color); flex-shrink: 0; }
        #capture-frame-btn { background-color: var(--danger); color: white; width: 60px; height: 60px; border-radius: 50%; font-size: 2rem; border: none; }
        #capture-frame-btn:hover { background-color: #f87171; }

        #frames-timeline-container { background-color: #000; padding: 0.5rem; overflow-x: auto; flex-shrink: 0; text-align: left; }
        #frames-timeline { display: inline-flex; gap: 0.5rem; min-height: 80px; align-items: center; }
        .frame-thumbnail { 
            width: 70px; height: 70px; border: 2px solid var(--border-color); 
            border-radius: 0.25rem; overflow: hidden; position: relative; flex-shrink: 0; 
            background-image: linear-gradient(45deg, #444 25%, transparent 25%), linear-gradient(-45deg, #444 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #444 75%), linear-gradient(-45deg, transparent 75%, #444 75%); 
            background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; 
        }
        .frame-thumbnail img { width: 100%; height: 100%; object-fit: contain; cursor: pointer; }
        .frame-thumbnail:hover { border-color: var(--primary); }
        .frame-actions { position: absolute; top: 2px; right: 2px; display: flex; gap: 2px; }
        .frame-action-btn { background-color: rgba(0,0,0,0.6); color: white; border: none; border-radius: 4px; width: 22px; height: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .frame-action-btn:hover { background-color: var(--primary); }
        .frame-action-btn i { font-size: 12px; }

        .frame-dimensions {
            position: absolute;
            bottom: 2px;
            left: 2px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 10px;
            font-family: monospace;
        }

        .modal { position: fixed; inset: 0; z-index: 50; background-color: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--secondary); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; width: 100%; max-width: 500px; max-height: 95vh; overflow-y: auto; }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; border: none; cursor: pointer; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #60a5fa; }
        .btn-secondary { background-color: #374151; color: var(--text-light); }
        .btn-secondary:hover { background-color: #4b5563; }

        .section-divider {
            border-color: var(--border-color);
            margin: 1.5rem 0;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            margin-bottom: 1rem;
        }
        .upload-prompt {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            background-color: #1f2937;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <div class="editor-container p-4">
            <header class="flex justify-between items-center pb-4">
                <h1 class="text-2xl font-bold">SpriteSheet Studio</h1>
                <button id="export-btn" class="btn btn-primary"><i class="fas fa-file-export mr-2"></i>Exportar Spritesheet</button>
            </header>

            <!-- Video Section -->
            <div id="video-section">
                <h2 class="section-title">Crear desde Video</h2>
                <div id="video-upload-prompt" class="upload-prompt">
                     <label for="video-upload" class="btn btn-primary"><i class="fas fa-video mr-2"></i> Seleccionar Video</label>
                     <p class="text-sm text-gray-400 mt-2">Sube un video para capturar frames.</p>
                </div>
                <div id="video-player-controls" class="hidden">
                    <div id="video-container">
                        <video id="video-player" muted></video>
                        <div id="video-crop-box">
                            <div class="video-crop-handle nw"></div><div class="video-crop-handle ne"></div>
                            <div class="video-crop-handle sw"></div><div class="video-crop-handle se"></div>
                        </div>
                    </div>
                    <div class="timeline-controls">
                        <div class="flex items-center gap-4">
                            <span id="current-time" class="text-sm">0:00.0</span>
                            <input type="range" id="timeline-slider" min="0" max="100" value="0" class="w-full">
                            <span id="duration" class="text-sm">0:00.0</span>
                        </div>
                        <div class="flex justify-center items-center gap-2">
                            <button id="prev-frame-btn" title="Frame Anterior" class="w-12 h-12 text-xl"><i class="fas fa-backward-step"></i></button>
                            <button id="play-pause-btn" title="Reproducir/Pausar" class="w-12 h-12 text-2xl"><i class="fas fa-play"></i></button>
                            <button id="next-frame-btn" title="Siguiente Frame" class="w-12 h-12 text-xl"><i class="fas fa-forward-step"></i></button>
                            <button id="toggle-crop-mode-btn" class="ml-4 text-xl w-12 h-12" title="Activar/Desactivar Recorte"><i class="fas fa-crop-alt"></i></button>
                        </div>
                    </div>
                    <div class="toolbar grid grid-cols-3 items-center">
                        <div class="flex flex-col items-center justify-center text-center">
                            <h3 class="font-bold mb-2">Quitar Fondo</h3>
                            <div class="flex items-center gap-3">
                                <button id="eyedropper-btn" class="btn btn-secondary text-xl w-12 h-12" title="Seleccionar color de fondo"><i class="fas fa-eye-dropper"></i></button>
                                <div id="color-preview" class="w-10 h-10 rounded border-2 border-gray-500 bg-gray-700"></div>
                            </div>
                            <div class="w-full max-w-xs px-4 mt-2">
                                <label for="chroma-tolerance" class="text-sm">Tolerancia: <span id="tolerance-value">20</span></label>
                                <input type="range" id="chroma-tolerance" min="0" max="200" value="20" class="w-full">
                            </div>
                        </div>
                        <div class="flex justify-center">
                            <button id="capture-frame-btn" title="Capturar Frame"><i class="fas fa-plus"></i></button>
                        </div>
                        <div></div>
                    </div>
                </div>
            </div>

            <hr class="section-divider">

            <!-- Image Section -->
            <div id="image-section">
                 <h2 class="section-title">Crear desde Imágenes</h2>
                 <div class="upload-prompt">
                    <label for="image-upload" class="btn btn-primary"><i class="fas fa-upload mr-2"></i> Subir Imágenes</label>
                    <p class="text-sm text-gray-400 mt-2">Selecciona una o varias imágenes para añadirlas a la línea de tiempo.</p>
                 </div>
            </div>

            <hr class="section-divider">

            <!-- Timeline Section -->
            <div class="w-full">
                <h2 class="section-title">Línea de Tiempo</h2>
                <div id="frames-timeline-container">
                    <div id="frames-timeline"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden file inputs -->
    <input type="file" id="video-upload" class="hidden" accept="video/*">
    <input type="file" id="image-upload" class="hidden" accept="image/*" multiple>
    
    <!-- Modals -->
    <div id="edit-frame-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-center mb-4">Editar Frame</h2>
            <div class="mb-4 p-2 rounded-lg flex items-center justify-center" style="background-image: linear-gradient(45deg, #444 25%, transparent 25%), linear-gradient(-45deg, #444 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #444 75%), linear-gradient(-45deg, transparent 75%, #444 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px;">
                <img id="edit-frame-preview" class="max-w-full max-h-48 object-contain" src="">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="edit-frame-width" class="block font-semibold text-sm mb-1">Ancho:</label>
                    <input type="number" id="edit-frame-width" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
                </div>
                <div>
                    <label for="edit-frame-height" class="block font-semibold text-sm mb-1">Alto:</label>
                    <input type="number" id="edit-frame-height" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
                </div>
            </div>
            <div class="mt-4 flex items-center">
                <input type="checkbox" id="edit-frame-aspect" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500" checked>
                <label for="edit-frame-aspect" class="ml-2 text-sm">Mantener proporción</label>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="cancel-edit-frame-btn" class="btn btn-secondary">Cancelar</button>
                <button id="save-edit-frame-btn" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </div>
    </div>
    <div id="export-modal" class="modal">
        <div class="modal-content max-w-3xl">
            <h2 class="text-2xl font-bold text-center mb-6">Opciones de Exportación</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <select id="export-preset" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
                        <option value="custom">Personalizado</option>
                        <option value="web">Web (Optimizado - max 1024px)</option>
                        <option value="mobile">Móvil (Estándar - max 2048px)</option>
                        <option value="pc">PC/Consola (Alta Calidad - max 4096px)</option>
                    </select>
                    <select id="export-layout" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
                        <option value="columns">Columnas</option>
                        <option value="rows">Filas</option>
                    </select>
                    <input type="number" id="export-count" value="8" min="1" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
                    <input type="number" id="export-padding" value="0" min="0" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
                    <select id="export-format" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
                        <option value="image/png">PNG (con transparencia)</option>
                        <option value="image/webp">WebP (Recomendado para web)</option>
                        <option value="image/jpeg">JPEG</option>
                    </select>
                    <div class="pt-2">
                        <label for="export-filename" class="text-sm font-semibold">Nombre del archivo:</label>
                        <input type="text" id="export-filename" value="spritesheet" class="w-full p-2 mt-1 rounded bg-gray-900 border border-gray-600">
                    </div>
                    <div class="pt-2">
                        <button id="toggle-spritesheet-crop-btn" class="btn btn-secondary w-full"><i class="fas fa-crop-alt mr-2"></i>Recortar Spritesheet</button>
                    </div>
                </div>
                <div id="export-preview-container" class="relative bg-black p-2 rounded-lg flex items-center justify-center min-h-[200px]" style="background-image: linear-gradient(45deg, #444 25%, transparent 25%), linear-gradient(-45deg, #444 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #444 75%), linear-gradient(-45deg, transparent 75%, #444 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px;">
                    <canvas id="export-preview-canvas" class="max-w-full max-h-full"></canvas>
                    <div id="spritesheet-crop-box" style="display: none; position: absolute; border: 2px dashed var(--primary); box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); cursor: move;">
                        <div class="video-crop-handle nw"></div><div class="video-crop-handle ne"></div>
                        <div class="video-crop-handle sw"></div><div class="video-crop-handle se"></div>
                    </div>
                </div>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="cancel-export-btn" class="btn btn-secondary">Cancelar</button>
                <button id="download-spritesheet-btn" class="btn btn-primary"><i class="fas fa-download mr-2"></i>Descargar Spritesheet</button>
            </div>
        </div>
    </div>
    <div id="download-frame-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-center mb-4">Descargar Frame</h2>
            <div class="mb-4 p-2 rounded-lg flex items-center justify-center" style="background-image: linear-gradient(45deg, #444 25%, transparent 25%), linear-gradient(-45deg, #444 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #444 75%), linear-gradient(-45deg, transparent 75%, #444 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px;">
                <img id="download-frame-preview" class="max-w-full max-h-64 object-contain" src="">
            </div>
            <div class="space-y-2">
                <label for="download-frame-name" class="block font-semibold">Nombre del archivo:</label>
                <input type="text" id="download-frame-name" class="w-full p-2 rounded bg-gray-800 border border-gray-600" placeholder="Ej: mi_personaje_salto_01">
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="cancel-download-frame-btn" class="btn btn-secondary">Cancelar</button>
                <button id="confirm-download-frame-btn" class="btn btn-primary"><i class="fas fa-download mr-2"></i>Descargar</button>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- UI Elements ---
        const videoUpload = document.getElementById('video-upload');
        const imageUpload = document.getElementById('image-upload');
        const videoUploadPrompt = document.getElementById('video-upload-prompt');
        const videoPlayerControls = document.getElementById('video-player-controls');
        const videoContainer = document.getElementById('video-container');
        const videoPlayer = document.getElementById('video-player');
        const videoCropBox = document.getElementById('video-crop-box');
        const toggleCropModeBtn = document.getElementById('toggle-crop-mode-btn');
        const timelineSlider = document.getElementById('timeline-slider');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const prevFrameBtn = document.getElementById('prev-frame-btn');
        const nextFrameBtn = document.getElementById('next-frame-btn');
        const captureFrameBtn = document.getElementById('capture-frame-btn');
        const framesTimeline = document.getElementById('frames-timeline');
        
        const eyedropperBtn = document.getElementById('eyedropper-btn');
        const colorPreview = document.getElementById('color-preview');
        const chromaToleranceSlider = document.getElementById('chroma-tolerance');
        const toleranceValueEl = document.getElementById('tolerance-value');

        const exportBtn = document.getElementById('export-btn');
        const exportModal = document.getElementById('export-modal');
        const cancelExportBtn = document.getElementById('cancel-export-btn');
        const downloadSpritesheetBtn = document.getElementById('download-spritesheet-btn');
        const exportPresetSelect = document.getElementById('export-preset');
        const exportLayoutSelect = document.getElementById('export-layout');
        const exportCountInput = document.getElementById('export-count');
        const exportCountLabel = document.getElementById('export-count-label');
        const exportPaddingInput = document.getElementById('export-padding');
        const exportFormatSelect = document.getElementById('export-format');
        const exportFilenameInput = document.getElementById('export-filename');
        const exportPreviewCanvas = document.getElementById('export-preview-canvas');
        const toggleSpritesheetCropBtn = document.getElementById('toggle-spritesheet-crop-btn');
        const spritesheetCropBox = document.getElementById('spritesheet-crop-box');
        const exportPreviewContainer = document.getElementById('export-preview-container');

        const downloadFrameModal = document.getElementById('download-frame-modal');
        const downloadFramePreview = document.getElementById('download-frame-preview');
        const downloadFrameNameInput = document.getElementById('download-frame-name');
        const cancelDownloadFrameBtn = document.getElementById('cancel-download-frame-btn');
        const confirmDownloadFrameBtn = document.getElementById('confirm-download-frame-btn');

        const editFrameModal = document.getElementById('edit-frame-modal');
        const editFramePreview = document.getElementById('edit-frame-preview');
        const editFrameWidthInput = document.getElementById('edit-frame-width');
        const editFrameHeightInput = document.getElementById('edit-frame-height');
        const editFrameAspectCheckbox = document.getElementById('edit-frame-aspect');
        const cancelEditFrameBtn = document.getElementById('cancel-edit-frame-btn');
        const saveEditFrameBtn = document.getElementById('save-edit-frame-btn');

        // --- App State ---
        let capturedFrames = [];
        const FRAME_STEP = 1 / 60; 
        let videoCrop = { x: 0, y: 0, width: 1, height: 1 };
        let isVideoCropMode = false;
        let cropAction = { active: false, type: null, startX: 0, startY: 0, initialCrop: {} };
        let chromaColor = null;
        let isSpritesheetCropMode = false;
        let spritesheetCrop = { x: 0, y: 0, width: 0, height: 0 };
        let spritesheetCropAction = { active: false, type: null, startX: 0, startY: 0, initialCrop: {} };
        let fullSheetCanvas = null;

        // --- Frame Processing Utility ---
        function processAndAddFrame(canvas) {
            capturedFrames.push({ id: `frame-${Date.now()}-${Math.random()}`, canvas: canvas });
            renderFramesTimeline();
        }


        // --- Video Loading & Controls ---
        videoUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                videoPlayer.src = URL.createObjectURL(file);
                videoUploadPrompt.classList.add('hidden');
                videoPlayerControls.classList.remove('hidden');
            }
        });
        videoPlayer.addEventListener('loadedmetadata', () => {
            durationEl.textContent = formatTime(videoPlayer.duration);
            timelineSlider.max = videoPlayer.duration;
            videoCrop = { x: 0, y: 0, width: videoPlayer.videoWidth, height: videoPlayer.videoHeight };
        });
        videoPlayer.addEventListener('timeupdate', () => {
            timelineSlider.value = videoPlayer.currentTime;
            currentTimeEl.textContent = formatTime(videoPlayer.currentTime);
        });
        timelineSlider.addEventListener('input', () => videoPlayer.currentTime = timelineSlider.value);
        playPauseBtn.addEventListener('click', () => {
            if (videoPlayer.paused) {
                videoPlayer.play();
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            } else {
                videoPlayer.pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
        });
        prevFrameBtn.addEventListener('click', () => videoPlayer.currentTime -= FRAME_STEP);
        nextFrameBtn.addEventListener('click', () => videoPlayer.currentTime += FRAME_STEP);
        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            const milli = Math.floor((seconds - Math.floor(seconds)) * 10);
            return `${min}:${sec.toString().padStart(2, '0')}.${milli}`;
        }

        // --- Image Uploading ---
        imageUpload.addEventListener('change', (event) => {
            const files = event.target.files;
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        canvas.getContext('2d').drawImage(img, 0, 0);
                        processAndAddFrame(canvas);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            imageUpload.value = ''; // Reset input
        });

        // --- Video Cropping ---
        toggleCropModeBtn.addEventListener('click', () => {
            isVideoCropMode = !isVideoCropMode;
            toggleCropModeBtn.classList.toggle('text-blue-500', isVideoCropMode);
            videoCropBox.style.display = isVideoCropMode ? 'block' : 'none';
            if (isVideoCropMode) {
                videoPlayer.pause();
                updateVideoCropBoxDisplay();
            }
        });
        function updateVideoCropBoxDisplay() {
            if (!videoPlayer.videoWidth) return;
            const videoRect = videoPlayer.getBoundingClientRect();
            const scaleX = videoRect.width / videoPlayer.videoWidth;
            const scaleY = videoRect.height / videoPlayer.videoHeight;
            videoCropBox.style.left = `${videoCrop.x * scaleX}px`;
            videoCropBox.style.top = `${videoCrop.y * scaleY}px`;
            videoCropBox.style.width = `${videoCrop.width * scaleX}px`;
            videoCropBox.style.height = `${videoCrop.height * scaleY}px`;
        }
        window.addEventListener('resize', updateVideoCropBoxDisplay);

        function startVideoCrop(e) {
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            cropAction.active = true;
            cropAction.startX = touch.clientX;
            cropAction.startY = touch.clientY;
            cropAction.initialCrop = { ...videoCrop };
            cropAction.type = e.target.classList.contains('video-crop-handle') ? e.target.className.split(' ')[1] : 'move';
        }

        function dragVideoCrop(e) {
            if (!cropAction.active) return;
            const touch = e.touches ? e.touches[0] : e;
            const videoRect = videoPlayer.getBoundingClientRect();
            const scaleX = videoPlayer.videoWidth / videoRect.width;
            const scaleY = videoPlayer.videoHeight / videoRect.height;
            const dx = (touch.clientX - cropAction.startX) * scaleX;
            const dy = (touch.clientY - cropAction.startY) * scaleY;
            let { x, y, width, height } = cropAction.initialCrop;
            switch (cropAction.type) {
                case 'move': x += dx; y += dy; break;
                case 'nw': x += dx; y += dy; width -= dx; height -= dy; break;
                case 'ne': y += dy; width += dx; height -= dy; break;
                case 'sw': x += dx; width -= dx; height += dy; break;
                case 'se': width += dx; height += dy; break;
            }
            videoCrop.x = Math.max(0, x);
            videoCrop.y = Math.max(0, y);
            videoCrop.width = Math.min(videoPlayer.videoWidth - videoCrop.x, width);
            videoCrop.height = Math.min(videoPlayer.videoHeight - videoCrop.y, height);
            updateVideoCropBoxDisplay();
        }

        function endVideoCrop() {
            cropAction.active = false;
        }

        videoCropBox.addEventListener('mousedown', startVideoCrop);
        window.addEventListener('mousemove', dragVideoCrop);
        window.addEventListener('mouseup', endVideoCrop);
        videoCropBox.addEventListener('touchstart', startVideoCrop, { passive: false });
        window.addEventListener('touchmove', dragVideoCrop, { passive: false });
        window.addEventListener('touchend', endVideoCrop);

        // --- Chroma Key ---
        eyedropperBtn.addEventListener('click', () => {
            videoContainer.classList.add('eyedropper-active');
            eyedropperBtn.classList.add('ring-2', 'ring-blue-500');
        });
        videoContainer.addEventListener('click', (e) => {
            if (!videoContainer.classList.contains('eyedropper-active')) return;
            const rect = videoPlayer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = videoPlayer.videoWidth;
            tempCanvas.height = videoPlayer.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(videoPlayer, 0, 0, tempCanvas.width, tempCanvas.height);
            
            const pixelX = Math.floor(x * (videoPlayer.videoWidth / rect.width));
            const pixelY = Math.floor(y * (videoPlayer.videoHeight / rect.height));

            const pixel = tempCtx.getImageData(pixelX, pixelY, 1, 1).data;
            chromaColor = [pixel[0], pixel[1], pixel[2]];
            
            colorPreview.style.backgroundColor = `rgb(${chromaColor[0]}, ${chromaColor[1]}, ${chromaColor[2]})`;
            videoContainer.classList.remove('eyedropper-active');
            eyedropperBtn.classList.remove('ring-2', 'ring-blue-500');
        });
        chromaToleranceSlider.addEventListener('input', (e) => {
            toleranceValueEl.textContent = e.target.value;
        });

        function applyChromaKey(canvas) {
            if (!chromaColor) return canvas;
            const tolerance = parseInt(chromaToleranceSlider.value);
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const [r, g, b] = chromaColor;
            for (let i = 0; i < data.length; i += 4) {
                const dist = Math.sqrt(
                    Math.pow(data[i] - r, 2) +
                    Math.pow(data[i + 1] - g, 2) +
                    Math.pow(data[i + 2] - b, 2)
                );
                if (dist < tolerance) {
                    data[i + 3] = 0; // Make transparent
                }
            }
            ctx.putImageData(imageData, 0, 0);
            return canvas;
        }

        // --- Frame Capturing & Timeline ---
        captureFrameBtn.addEventListener('click', () => {
            const { x, y, width, height } = videoCrop;
            if (width <= 1 || height <= 1) return;
            let canvas = document.createElement('canvas');
            canvas.width = Math.round(width);
            canvas.height = Math.round(height);
            canvas.getContext('2d').drawImage(videoPlayer, x, y, width, height, 0, 0, width, height);
            
            canvas = applyChromaKey(canvas);

            processAndAddFrame(canvas);
        });
        function renderFramesTimeline() {
            framesTimeline.innerHTML = '';
            capturedFrames.forEach((frameData) => {
                const thumb = document.createElement('div');
                thumb.className = 'frame-thumbnail';
                
                const img = document.createElement('img');
                img.src = frameData.canvas.toDataURL();
                thumb.appendChild(img);

                const actions = document.createElement('div');
                actions.className = 'frame-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'frame-action-btn';
                editBtn.title = 'Editar Frame';
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.onclick = () => openEditModal(frameData.id);
                actions.appendChild(editBtn);

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'frame-action-btn';
                downloadBtn.title = 'Descargar Frame';
                downloadBtn.innerHTML = '<i class="fas fa-download"></i>';
                downloadBtn.onclick = () => openDownloadModal(frameData.id);
                actions.appendChild(downloadBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'frame-action-btn';
                deleteBtn.title = 'Eliminar Frame';
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteFrame(frameData.id);
                };
                actions.appendChild(deleteBtn);
                thumb.appendChild(actions);

                const dims = document.createElement('div');
                dims.className = 'frame-dimensions';
                dims.textContent = `${frameData.canvas.width}x${frameData.canvas.height}`;
                thumb.appendChild(dims);

                framesTimeline.appendChild(thumb);
            });
        }

        function deleteFrame(frameId) {
            const frameIndex = capturedFrames.findIndex(f => f.id === frameId);
            if (frameIndex > -1) {
                capturedFrames.splice(frameIndex, 1);
                renderFramesTimeline();
            }
        }

        // --- Frame Editing ---
        let currentFrameAspectRatio = 1;

        function openEditModal(frameId) {
            const frameData = capturedFrames.find(f => f.id === frameId);
            if (!frameData) return;

            editFramePreview.src = frameData.canvas.toDataURL();
            editFrameWidthInput.value = frameData.canvas.width;
            editFrameHeightInput.value = frameData.canvas.height;
            currentFrameAspectRatio = frameData.canvas.width / frameData.canvas.height;
            editFrameAspectCheckbox.checked = true;

            editFrameModal.dataset.frameId = frameId;
            editFrameModal.classList.add('active');
        }

        editFrameWidthInput.addEventListener('input', () => {
            if (editFrameAspectCheckbox.checked) {
                const newWidth = parseInt(editFrameWidthInput.value);
                if (!isNaN(newWidth) && newWidth > 0) {
                    editFrameHeightInput.value = Math.round(newWidth / currentFrameAspectRatio);
                }
            }
        });

        editFrameHeightInput.addEventListener('input', () => {
            if (editFrameAspectCheckbox.checked) {
                const newHeight = parseInt(editFrameHeightInput.value);
                if (!isNaN(newHeight) && newHeight > 0) {
                    editFrameWidthInput.value = Math.round(newHeight * currentFrameAspectRatio);
                }
            }
        });

        editFrameAspectCheckbox.addEventListener('change', () => {
            if (editFrameAspectCheckbox.checked) {
                const width = parseInt(editFrameWidthInput.value);
                const height = parseInt(editFrameHeightInput.value);
                if (width > 0 && height > 0) {
                   currentFrameAspectRatio = width / height;
                }
            }
        });

        cancelEditFrameBtn.addEventListener('click', () => {
            editFrameModal.classList.remove('active');
        });

        saveEditFrameBtn.addEventListener('click', () => {
            const frameId = editFrameModal.dataset.frameId;
            const frameIndex = capturedFrames.findIndex(f => f.id === frameId);
            if (frameIndex === -1) return;

            const originalCanvas = capturedFrames[frameIndex].canvas;
            const newWidth = parseInt(editFrameWidthInput.value);
            const newHeight = parseInt(editFrameHeightInput.value);

            if (isNaN(newWidth) || isNaN(newHeight) || newWidth <= 0 || newHeight <= 0) {
                alert("Dimensiones inválidas.");
                return;
            }

            const newCanvas = document.createElement('canvas');
            newCanvas.width = newWidth;
            newCanvas.height = newHeight;
            const ctx = newCanvas.getContext('2d');
            ctx.drawImage(originalCanvas, 0, 0, newWidth, newHeight);

            capturedFrames[frameIndex].canvas = newCanvas;

            editFrameModal.classList.remove('active');
            renderFramesTimeline();

            if(exportModal.classList.contains('active')) {
                generateSpritesheetPreview();
            }
        });

        // --- Drag and Drop Reordering ---
        new Sortable(framesTimeline, {
            animation: 150,
            ghostClass: 'opacity-50',
            onEnd: (evt) => {
                const [movedItem] = capturedFrames.splice(evt.oldIndex, 1);
                capturedFrames.splice(evt.newIndex, 0, movedItem);
            }
        });
        
        // --- Single Frame Download ---
        function openDownloadModal(frameId) {
            const frameData = capturedFrames.find(f => f.id === frameId);
            if (!frameData) return;

            downloadFramePreview.src = frameData.canvas.toDataURL();
            downloadFrameNameInput.value = `frame_${frameData.id.split('-')[1]}`;
            downloadFrameModal.dataset.frameId = frameId;
            downloadFrameModal.classList.add('active');
        }

        cancelDownloadFrameBtn.addEventListener('click', () => {
            downloadFrameModal.classList.remove('active');
        });

        confirmDownloadFrameBtn.addEventListener('click', () => {
            const frameId = downloadFrameModal.dataset.frameId;
            const frameData = capturedFrames.find(f => f.id === frameId);
            if (!frameData) return;

            const filename = (downloadFrameNameInput.value || `frame_${Date.now()}`) + '.png';
            
            const link = document.createElement('a');
            link.href = frameData.canvas.toDataURL('image/png');
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            downloadFrameModal.classList.remove('active');
        });

        // --- Spritesheet Export ---
        exportBtn.addEventListener('click', () => {
            if (capturedFrames.length === 0) {
                alert("No hay frames en la línea de tiempo.");
                return;
            }
            exportModal.classList.add('active');
            generateSpritesheetPreview();
        });

        cancelExportBtn.addEventListener('click', () => {
            exportModal.classList.remove('active');
            isSpritesheetCropMode = false;
            spritesheetCropBox.style.display = 'none';
            toggleSpritesheetCropBtn.classList.remove('btn-primary', 'btn-secondary');
            toggleSpritesheetCropBtn.classList.add('btn-secondary');
        });

        const allExportInputs = [exportCountInput, exportPaddingInput, exportPresetSelect, exportLayoutSelect];
        allExportInputs.forEach(el => el.addEventListener('input', generateSpritesheetPreview));

        exportLayoutSelect.addEventListener('input', (e) => {
            exportCountLabel.textContent = e.target.value === 'columns' ? 'Columnas' : 'Filas';
            exportPresetSelect.value = 'custom';
        });

        exportPresetSelect.addEventListener('input', () => {
            exportLayoutSelect.value = 'columns';
            exportCountLabel.textContent = 'Columnas';
            generateSpritesheetPreview();
        });

        function getPowerOfTwo(n) {
            return Math.pow(2, Math.ceil(Math.log(n) / Math.log(2)));
        }

        function generateSpritesheet() {
            if (capturedFrames.length === 0) return null;

            const count = parseInt(exportCountInput.value) || 1;
            const padding = parseInt(exportPaddingInput.value) || 0;
            const preset = exportPresetSelect.value;
            const layout = exportLayoutSelect.value;

            let maxWidth = 0;
            let maxHeight = 0;
            capturedFrames.forEach(frame => {
                if (frame.canvas.width > maxWidth) maxWidth = frame.canvas.width;
                if (frame.canvas.height > maxHeight) maxHeight = frame.canvas.height;
            });

            let columns, rows;

            if (preset !== 'custom') {
                const MAX_SIZES = { web: 1024, mobile: 2048, pc: 4096 };
                const maxSize = MAX_SIZES[preset];
                columns = Math.max(1, Math.floor((maxSize - padding) / (maxWidth + padding)));
                rows = Math.ceil(capturedFrames.length / columns);
                exportCountInput.value = columns;
            } else {
                 if (layout === 'columns') {
                    columns = count;
                    rows = Math.ceil(capturedFrames.length / columns);
                } else {
                    rows = count;
                    columns = Math.ceil(capturedFrames.length / rows);
                }
            }

            let sheetWidth = (maxWidth * columns) + (padding * (columns + 1));
            let sheetHeight = (maxHeight * rows) + (padding * (rows + 1));

            if (preset !== 'custom') {
                 sheetWidth = getPowerOfTwo(sheetWidth);
                 sheetHeight = getPowerOfTwo(sheetHeight);
            }

            const sheetCanvas = document.createElement('canvas');
            sheetCanvas.width = sheetWidth;
            sheetCanvas.height = sheetHeight;
            const ctx = sheetCanvas.getContext('2d');

            capturedFrames.forEach((frame, index) => {
                let col, row;
                if (layout === 'columns') {
                    col = index % columns;
                    row = Math.floor(index / columns);
                } else {
                    row = index % rows;
                    col = Math.floor(index / rows);
                }

                const x = padding + col * (maxWidth + padding) + (maxWidth - frame.canvas.width) / 2;
                const y = padding + row * (maxHeight + padding) + (maxHeight - frame.canvas.height) / 2;
                ctx.drawImage(frame.canvas, x, y);
            });
            
            return sheetCanvas;
        }
        function generateSpritesheetPreview() {
            fullSheetCanvas = generateSpritesheet(); // Store the full-res canvas
            if (!fullSheetCanvas) return;

            const previewCtx = exportPreviewCanvas.getContext('2d');
            const container = exportPreviewContainer;
            const aspect = fullSheetCanvas.width / fullSheetCanvas.height;

            let newWidth = container.clientWidth - 4; // -4 for padding
            let newHeight = newWidth / aspect;
            if (newHeight > container.clientHeight - 4) {
                newHeight = container.clientHeight - 4;
                newWidth = newHeight * aspect;
            }
            exportPreviewCanvas.width = newWidth;
            exportPreviewCanvas.height = newHeight;

            previewCtx.clearRect(0, 0, newWidth, newHeight);
            previewCtx.drawImage(fullSheetCanvas, 0, 0, newWidth, newHeight);

            if (isSpritesheetCropMode) {
                const previewRect = exportPreviewCanvas.getBoundingClientRect();
                spritesheetCrop = { x: 0, y: 0, width: previewRect.width, height: previewRect.height };
                updateSpritesheetCropBoxDisplay();
            }
        }

        // --- Spritesheet Cropping Logic ---
        toggleSpritesheetCropBtn.addEventListener('click', () => {
            isSpritesheetCropMode = !isSpritesheetCropMode;
            spritesheetCropBox.style.display = isSpritesheetCropMode ? 'block' : 'none';
            toggleSpritesheetCropBtn.classList.toggle('btn-primary', isSpritesheetCropMode);
            toggleSpritesheetCropBtn.classList.toggle('btn-secondary', !isSpritesheetCropMode);
            if (isSpritesheetCropMode) {
                const previewRect = exportPreviewCanvas.getBoundingClientRect();
                const containerRect = exportPreviewContainer.getBoundingClientRect();
                const offsetX = (containerRect.width - previewRect.width) / 2;
                const offsetY = (containerRect.height - previewRect.height) / 2;

                spritesheetCrop = { x: offsetX, y: offsetY, width: previewRect.width, height: previewRect.height };
                updateSpritesheetCropBoxDisplay();
            }
        });

        function updateSpritesheetCropBoxDisplay() {
            if (!isSpritesheetCropMode) return;
            spritesheetCropBox.style.left = `${spritesheetCrop.x}px`;
            spritesheetCropBox.style.top = `${spritesheetCrop.y}px`;
            spritesheetCropBox.style.width = `${spritesheetCrop.width}px`;
            spritesheetCropBox.style.height = `${spritesheetCrop.height}px`;
        }

        function startSpritesheetCrop(e) {
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            spritesheetCropAction.active = true;
            spritesheetCropAction.startX = touch.clientX;
            spritesheetCropAction.startY = touch.clientY;
            spritesheetCropAction.initialCrop = { ...spritesheetCrop };
            spritesheetCropAction.type = e.target.classList.contains('video-crop-handle') ? e.target.className.split(' ')[1] : 'move';
        }

        function dragSpritesheetCrop(e) {
            if (!spritesheetCropAction.active) return;
            const touch = e.touches ? e.touches[0] : e;
            const dx = touch.clientX - spritesheetCropAction.startX;
            const dy = touch.clientY - spritesheetCropAction.startY;
            let { x, y, width, height } = spritesheetCropAction.initialCrop;

            switch (spritesheetCropAction.type) {
                case 'move': x += dx; y += dy; break;
                case 'nw': x += dx; y += dy; width -= dx; height -= dy; break;
                case 'ne': y += dy; width += dx; height -= dy; break;
                case 'sw': x += dx; width -= dx; height += dy; break;
                case 'se': width += dx; height += dy; break;
            }

            const previewRect = exportPreviewCanvas.getBoundingClientRect();
            const containerRect = exportPreviewContainer.getBoundingClientRect();
            const offsetX = (containerRect.width - previewRect.width) / 2;
            const offsetY = (containerRect.height - previewRect.height) / 2;

            const newX = Math.max(offsetX, x);
            const newY = Math.max(offsetY, y);
            spritesheetCrop.x = newX;
            spritesheetCrop.y = newY;
            spritesheetCrop.width = Math.min(offsetX + previewRect.width - newX, width);
            spritesheetCrop.height = Math.min(offsetY + previewRect.height - newY, height);

            updateSpritesheetCropBoxDisplay();
        }

        function endSpritesheetCrop() {
            spritesheetCropAction.active = false;
        }

        spritesheetCropBox.addEventListener('mousedown', startSpritesheetCrop);
        window.addEventListener('mousemove', dragSpritesheetCrop);
        window.addEventListener('mouseup', endSpritesheetCrop);
        spritesheetCropBox.addEventListener('touchstart', startSpritesheetCrop, { passive: false });
        window.addEventListener('touchmove', dragSpritesheetCrop, { passive: false });
        window.addEventListener('touchend', endSpritesheetCrop);

        downloadSpritesheetBtn.addEventListener('click', () => {
            let canvasToDownload = fullSheetCanvas;
            if (isSpritesheetCropMode && fullSheetCanvas) {
                const scaleX = fullSheetCanvas.width / exportPreviewCanvas.width;
                const scaleY = fullSheetCanvas.height / exportPreviewCanvas.height;

                const containerRect = exportPreviewContainer.getBoundingClientRect();
                const previewRect = exportPreviewCanvas.getBoundingClientRect();
                const offsetX = (containerRect.width - previewRect.width) / 2;
                const offsetY = (containerRect.height - previewRect.height) / 2;

                const sourceX = (spritesheetCrop.x - offsetX) * scaleX;
                const sourceY = (spritesheetCrop.y - offsetY) * scaleY;
                const sourceWidth = spritesheetCrop.width * scaleX;
                const sourceHeight = spritesheetCrop.height * scaleY;

                if (sourceWidth > 0 && sourceHeight > 0) {
                    const croppedCanvas = document.createElement('canvas');
                    croppedCanvas.width = Math.round(sourceWidth);
                    croppedCanvas.height = Math.round(sourceHeight);
                    const ctx = croppedCanvas.getContext('2d');
                    ctx.drawImage(fullSheetCanvas, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, croppedCanvas.width, croppedCanvas.height);
                    canvasToDownload = croppedCanvas;
                }
            }

            if (!canvasToDownload) {
                alert("Error al generar el spritesheet. Inténtalo de nuevo.");
                return;
            }

            const format = exportFormatSelect.value;
            const quality = format === 'image/jpeg' ? 0.9 : 1.0;
            const filename = (exportFilenameInput.value || 'spritesheet') + '.' + format.split('/')[1];

            const dataUrl = canvasToDownload.toDataURL(format, quality);
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    });
    </script>
</body>
</html>
